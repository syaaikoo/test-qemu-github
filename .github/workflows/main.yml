name: Debian 13 NoVNC (Disk Fixed)

on:
  workflow_dispatch:

jobs:
  run-vm:
    runs-on: ubuntu-latest

    steps:
      - name: üõ†Ô∏è 1. Persiapan & Install QEMU + NoVNC
        run: |
          echo "============================================="
          echo "üü¢ Installing QEMU, NoVNC & dependencies..."
          echo "============================================="
          sudo apt-get update
          sudo apt-get install -y qemu-kvm qemu-utils novnc websockify
          sudo ln -s /usr/share/novnc/vnc.html /usr/share/novnc/index.html
          echo "‚úÖ Installation completed!"
          echo ""

      - name: üíæ 2. Unduh ISO Debian 13 & Buat Disk Virtual
        run: |
          echo "============================================="
          echo "üíø Membuat Disk Virtual 40GB..."
          echo "============================================="
          qemu-img create -f qcow2 debian_disk.qcow2 45G
          echo "‚úÖ Disk virtual siap!"

          echo "============================================="
          echo "üåê Mengunduh ISO Debian 13..."
          echo "============================================="
          wget -O debian.iso https://cdimage.debian.org/debian-cd/current/amd64/iso-cd/debian-13.2.0-amd64-netinst.iso
          echo "‚úÖ ISO berhasil diunduh!"
          echo ""

      - name: üöÄ 3. Jalankan QEMU (Background)
        run: |
          echo "============================================="
          echo "‚ö° Starting QEMU with VirtIO disk..."
          echo "============================================="
          sudo qemu-system-x86_64 \
            -enable-kvm \
            -cpu host \
            -smp 2 \
            -m 4G \
            -drive file=debian.iso,media=cdrom \
            -boot d \
            -drive file=debian_disk.qcow2,if=virtio \
            -net nic,model=virtio -net user \
            -vnc :0 \
            -device virtio-rng-pci \
            -daemonize \
            -display none
          echo "‚úÖ QEMU berjalan di VNC :0 (Port 5900)"
          echo ""

      - name: üåê 4. Jalankan NoVNC / Websockify (Background)
        run: |
          echo "============================================="
          echo "üîó Menjalankan NoVNC pada port 6080..."
          echo "============================================="
          websockify --web=/usr/share/novnc/ 6080 localhost:5900 &
          echo "‚úÖ NoVNC siap diakses!"
          echo ""

      - name: üîí 5. Start Cloudflare Tunnel & Generate URL
        run: |
          echo "============================================="
          echo "üåâ Menjalankan Cloudflare Tunnel..."
          echo "============================================="
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
          chmod +x cloudflared-linux-amd64
          sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared

          cloudflared tunnel --url http://127.0.0.1:6080 > cloudflared.log 2>&1 &
          sleep 10

          TUNNEL_URL=$(grep -o 'https://[^ ]*.trycloudflare.com' cloudflared.log | head -n 1)

          if [ -z "$TUNNEL_URL" ]; then
            echo "::error::Gagal ambil URL. Cek log:"
            cat cloudflared.log
            exit 1
          fi

          echo "‚úÖ Tunnel aktif!"
          echo "üåê Akses browser di sini: $TUNNEL_URL"
          echo "TUNNEL_URL=$TUNNEL_URL" >> $GITHUB_ENV
          echo ""

      - name: ‚è≥ 6. Keep Alive (6 Jam)
        run: |
          echo "============================================="
          echo "‚è±Ô∏è Menjaga VM tetap hidup selama 6 jam..."
          echo "============================================="
          echo "‚úÖ Hard disk sudah dilampirkan."
          echo "üåê Buka link ini di browser: ${{ env.TUNNEL_URL }}"
          echo "============================================="
          sleep 21600
