name: Debian 13 KVM Fixed (No Token)

on: 
  workflow_dispatch: 

jobs:
  run-vm:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check Out Kode
        uses: actions/checkout@v4

      - name: Unduh ISO Debian 13
        run: wget -O debian.iso https://cdimage.debian.org/debian-cd/current/amd64/iso-cd/debian-13.2.0-amd64-netinst.iso

      - name: Instal cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
          chmod +x cloudflared-linux-amd64
          sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared

      - name: Set Up Cloudflare Quick Tunnel (FIXED)
        id: tunnel_setup
        run: |
          echo "--- MEMULAI CLOUDFLARE QUICK TUNNEL ---"
          
          # PERBAIKAN: Menghapus kata 'run'. 
          # Menggunakan syntax '--url' langsung untuk Quick Tunnel.
          # Menggunakan '2>&1' untuk memastikan error log juga tertangkap jika ada.
          /usr/local/bin/cloudflared tunnel --url tcp://127.0.0.1:5900 > cloudflared.log 2>&1 &
          
          # Tunggu 15 detik agar tunnel connect
          sleep 15
          
          # Debug: Tampilkan 20 baris pertama log untuk memastikan tunnel jalan
          echo "--- Pengecekan Log Awal ---"
          head -n 20 cloudflared.log
          
          # Ambil URL. Cloudflared kadang memberikan output .trycloudflare.com
          TUNNEL_URL=$(grep -o 'https://[^ ]*.trycloudflare.com' cloudflared.log | head -n 1)
          
          if [ -z "$TUNNEL_URL" ]; then
            echo "::error::Gagal mendapatkan URL! Cek log di bawah:"
            cat cloudflared.log
            exit 1
          fi
          
          echo "::notice::URL AKSES VNC ANDA: $TUNNEL_URL"
          echo "TUNNEL_URL=$TUNNEL_URL" >> $GITHUB_ENV

      - name: Jalankan VM QEMU/KVM (6 Jam)
        uses: etchdroid/qemu-kvm-action@v1
        with:
          # Kita gunakan 'run' manual agar parameter QEMU pasti benar
          run: |
            echo "--- MEMULAI QEMU ---"
            echo "Akses URL ini di browser/VNC client: ${{ env.TUNNEL_URL }}"
            
            # Menjalankan QEMU
            /usr/bin/qemu-system-x86_64 \
            -enable-kvm \
            -cpu host \
            -smp 2 \
            -m 4G \
            -display vnc=:0 \
            -cdrom debian.iso \
            -boot d \
            -device virtio-rng-pci &
            
            # Loop keep-alive selama 6 jam (21600 detik)
            echo "VM Berjalan. Jangan tutup tab ini jika ingin melihat log."
            sleep 21600
