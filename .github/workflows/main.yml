name: Debian 13 KVM 6 Jam via Cloudflare Quick Tunnel

on: 
  # Anda dapat memulai workflow ini secara manual dari tab Actions
  workflow_dispatch: 

jobs:
  run-vm:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check Out Kode
        uses: actions/checkout@v4

      - name: Unduh ISO Debian 13
        # Menggunakan link ISO Debian 13 netinst yang Anda berikan
        run: wget -O debian.iso https://cdimage.debian.org/debian-cd/current/amd64/iso-cd/debian-13.2.0-amd64-netinst.iso

      - name: Instal cloudflared
        # Unduh dan instal binary cloudflared
        run: |
          echo "--- MENGINSTAL CLOUDFLARED ---"
          wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
          chmod +x cloudflared-linux-amd64
          sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared

      - name: Set Up Cloudflare Quick Tunnel dan Ambil URL
        id: tunnel_setup
        run: |
          echo "--- MEMULAI CLOUDFLARE QUICK TUNNEL ---"
          
          # Jalankan cloudflared di background dan arahkan log ke cloudflared.log
          # VNC akan diekspos di port TCP 5900
          /usr/local/bin/cloudflared tunnel run --url tcp://127.0.0.1:5900 &> cloudflared.log &
          
          # Tunggu 30 detik agar tunnel stabil dan URL tercatat di log
          sleep 30 
          
          # Mengambil URL publik (format https://[random].trycloudflare.com)
          TUNNEL_URL=$(grep -o 'https://[^ ]*.trycloudflare.com' cloudflared.log | head -1)
          
          # Pemeriksaan Kritis: Jika URL kosong, hentikan eksekusi dan tampilkan log debug
          if [ -z "$TUNNEL_URL" ]; then
            echo "::error::Gagal mendapatkan Cloudflare Tunnel URL!"
            echo "Log Cloudflare:"
            cat cloudflared.log
            exit 1
          fi
          
          # Tampilkan URL sebagai output dan notifikasi
          echo "::notice file=URL.txt::URL AKSES VNC ANDA: $TUNNEL_URL"
          echo "=========================================================="
          echo "  URL AKSES VNC (Gunakan di Klien NoVNC/VNC):"
          echo "  $TUNNEL_URL"
          echo "=========================================================="
          
          # Simpan URL sebagai output agar bisa diakses jika diperlukan
          echo "TUNNEL_URL=$TUNNEL_URL" >> $GITHUB_ENV

      - name: Jalankan VM QEMU/KVM dan Jeda 6 Jam
        # Menggunakan Action hanya untuk setup dependency, dan menggunakan 'run' untuk QEMU kustom
        uses: etchdroid/qemu-kvm-action@v1
        with:
          # Kita tidak menggunakan parameter bawaan 'image', 'vnc', dll., karena error.
          # Kita akan menggunakan perintah 'run' untuk eksekusi QEMU manual yang terjamin.
          run: |
            echo "--- MEMULAI QEMU KVM DENGAN DEBIAN ---"
            
            # Perintah QEMU kustom
            /usr/bin/qemu-system-x86_64 \
            -enable-kvm \
            -cpu host \
            -smp 2 \
            -m 4G \
            -display vnc=:0 \
            -cdrom debian.iso \
            -boot d \
            -device virtio-rng-pci &
            
            echo "VM sudah berjalan di background. VNC terbuka di port 5900."
            echo "Jeda 6 jam (21600 detik) untuk interaksi..."
            
            # Jeda 6 jam (batas maksimal interaksi)
            sleep 21600

